<div class="modal-overlay">
  <div class="modal-container">
    <div class="modal-card bulk-modal">
      
      <!-- Header -->
      <div class="modal-header">
        <div class="header-content">
          <h2>Bulk Add/Update Products</h2>
          <p>Upload Excel or CSV file to add multiple products</p>
        </div>
        <button type="button" class="modal-close" (click)="cancel()">Ã—</button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        
        <!-- File Upload Section -->
        <div class="upload-section">
          <label class="upload-label">
            <fa-icon [icon]="faUpload"></fa-icon>
            <span>Choose File</span>
            <input 
              type="file" 
              accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" 
              (change)="onFileChange($event)"
              style="display: none" />
          </label>
          <p class="file-info" *ngIf="selectedFile">
            <fa-icon [icon]="faFile"></fa-icon>
            {{ selectedFile.name }}
          </p>
          <p class="upload-hint">Supported formats: .xlsx, .xls, .csv</p>
        </div>

        <!-- Header Toggle -->
        <div class="checkbox-group">
          <label class="custom-checkbox">
            <input 
              type="checkbox" 
              [(ngModel)]="firstRowIsHeader" 
              (change)="toggleHeader()" />
            <span class="checkbox-mark"></span>
            <span class="checkbox-label">First row is header</span>
          </label>
        </div>

        <!-- Column Mapping -->
        <div class="mapping-section" *ngIf="previewHeaders && previewHeaders.length">
          <div class="section-title">
            <fa-icon [icon]="faColumns"></fa-icon>
            <span>Column Mapping</span>
          </div>

          <div class="mapping-list">
            <div class="mapping-item" *ngFor="let field of internalFields">
              <div class="mapping-label">
                <span>{{ field.label }}</span>
              </div>
              <div class="mapping-control">
                <select 
                  class="mapping-select" 
                  [(ngModel)]="mapping[field.key]" 
                  (ngModelChange)="onMappingChange()">
                  <option [ngValue]="null">-- Not mapped --</option>
                  <option 
                    *ngFor="let h of previewHeaders" 
                    [value]="h" 
                    [disabled]="isHeaderSelected(h) && mapping[field.key] !== h">
                    {{ h }}
                  </option>
                </select>
                <div class="validation-warning" *ngIf="numericIssues[field.key]">
                  <fa-icon [icon]="faExclamationTriangle"></fa-icon>
                  {{ numericIssues[field.key].invalidCount }} invalid values
                  <span class="warning-samples">({{ numericIssues[field.key].samples.join(', ') }})</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Preview Table -->
          <div class="preview-section">
            <div class="section-title">
              <fa-icon [icon]="faEye"></fa-icon>
              <span>Preview (First 10 rows)</span>
            </div>
            <div class="table-container">
              <table class="preview-table">
                <thead>
                  <tr>
                    <th *ngFor="let h of previewHeaders">{{ h }}</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let row of previewRows">
                    <td *ngFor="let cell of row">{{ cell }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Error Messages -->
        <div class="alert alert-danger" *ngIf="fileError">
          <fa-icon [icon]="faExclamationCircle"></fa-icon>
          {{ fileError }}
        </div>
        <div class="alert alert-warning" *ngIf="!numericValidationPassed && !fileError">
          <fa-icon [icon]="faExclamationTriangle"></fa-icon>
          Some mapped numeric columns contain invalid values. Please review.
        </div>

      </div>

      <!-- Footer -->
      <div class="modal-footer">
        <button type="button" class="modal-btn secondary" (click)="cancel()">
          Cancel
        </button>
        <button 
          type="button" 
          class="modal-btn primary" 
          [disabled]="!selectedFile || submitting || !isValidMapping()" 
          (click)="submit()">
          <fa-icon [icon]="faCloudUploadAlt" *ngIf="!submitting"></fa-icon>
          <span class="spinner-small" *ngIf="submitting"></span>
          {{ submitting ? 'Uploading...' : 'Submit' }}
        </button>
      </div>

    </div>
  </div>
</div>