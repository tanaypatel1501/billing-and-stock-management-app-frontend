<ng-template #noProductsMessage>
  <div class="empty-state-wrapper">
    <div class="empty-state-card">
      <div class="empty-state-icon">üì¶</div>
      <h2>No Products in Stock</h2>
      <p>Products available in stock will appear here</p>
    </div>
  </div>
</ng-template>

<ng-container *ngIf="initialLoadComplete">
  <ng-container *ngIf="stock.length > 0 || isSearchActive; else noProductsMessage">
    
    <div class="dashboard-wrapper">
      <div class="main-content">
        
        <!-- Modern Header -->
        <div class="modern-header">
          <div class="header-left">
            <button
              class="back-btn"
              (click)="resetView()"
              title="Reset Filters & Search"
              *ngIf="searchText.length > 0">
              <fa-icon [icon]="faArrowLeft"></fa-icon>
            </button>
            
            <div class="header-title-wrapper">
              <h1 class="header-title">
                <span class="title-text">Products in Stock</span>
                <fa-icon [icon]="faCartFlatbed" class="title-icon"></fa-icon>
              </h1>
              <span class="stock-count">{{ stock.length }} item(s)</span>
            </div>
          </div>

          <div class="header-right">
            <app-search-bar
              [suggestions]="suggestions"
              [labelKey]="'product.name'" 
              [subLabelKey]="'product.packing'"
              (onType)="handleTyping($event)"
              (onSelect)="handleSearch($event)"
              (onSearch)="handleSearch($event)"
              notFoundText="products">
            </app-search-bar>
            <app-filter-button 
              [columns]="filterColumns" 
              [currentSortBy]="sortColumn"
              [currentDirection]="sortDirection"
              (onApplySort)="handleFilterSort($any($event))">
            </app-filter-button>
          </div>
        </div>

        <!-- Modern Table Container -->
        <div class="stock-table-container">
          <div class="table-wrapper" (click)="collapseAll()">
            <table class="modern-stock-table">
              <thead>
                <tr>
                  <th scope="col">#</th>
                  
                  <th scope="col" (dblclick)="onDoubleClickSort('product.name')" class="sortable-header">
                    Product Name 
                    <span class="sort-icon">
                      <span *ngIf="sortColumn === 'product.name'">{{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}</span>
                      <span *ngIf="sortColumn !== 'product.name'" class="neutral-sort">‚áÖ</span>
                    </span>
                  </th>

                  <th scope="col" (dblclick)="onDoubleClickSort('product.packing')" class="sortable-header">
                    Packing
                    <span class="sort-icon">
                      <span *ngIf="sortColumn === 'product.packing'">{{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}</span>
                      <span *ngIf="sortColumn !== 'product.packing'" class="neutral-sort">‚áÖ</span>
                    </span>
                  </th>

                  <th scope="col" (dblclick)="onDoubleClickSort('product.HSN')" class="sortable-header">
                    HSN
                    <span class="sort-icon">
                      <span *ngIf="sortColumn === 'product.HSN'">{{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}</span>
                      <span *ngIf="sortColumn !== 'product.HSN'" class="neutral-sort">‚áÖ</span>
                    </span>
                  </th>

                  <th scope="col" (dblclick)="onDoubleClickSort('batchNo')" class="sortable-header">
                    Batch No.
                    <span class="sort-icon">
                      <span *ngIf="sortColumn === 'batchNo'">{{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}</span>
                      <span *ngIf="sortColumn !== 'batchNo'" class="neutral-sort">‚áÖ</span>
                    </span>
                  </th>

                  <th scope="col" (dblclick)="onDoubleClickSort('expiryDate')" class="sortable-header">
                    Expiry Date
                    <span class="sort-icon">
                      <span *ngIf="sortColumn === 'expiryDate'">{{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}</span>
                      <span *ngIf="sortColumn !== 'expiryDate'" class="neutral-sort">‚áÖ</span>
                    </span>
                  </th>

                  <th scope="col" (dblclick)="onDoubleClickSort('quantity')" class="sortable-header">
                    Quantity
                    <span class="sort-icon">
                      <span *ngIf="sortColumn === 'quantity'">{{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}</span>
                      <span *ngIf="sortColumn !== 'quantity'" class="neutral-sort">‚áÖ</span>
                    </span>
                  </th>

                  <th scope="col" (dblclick)="onDoubleClickSort('product.MRP')" class="sortable-header">
                    MRP
                    <span class="sort-icon">
                      <span *ngIf="sortColumn === 'product.MRP'">{{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}</span>
                      <span *ngIf="sortColumn !== 'product.MRP'" class="neutral-sort">‚áÖ</span>
                    </span>
                  </th>

                  <th scope="col" (dblclick)="onDoubleClickSort('product.CGST')" class="sortable-header">
                    CGST
                    <span class="sort-icon">
                      <span *ngIf="sortColumn === 'product.CGST'">{{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}</span>
                      <span *ngIf="sortColumn !== 'product.CGST'" class="neutral-sort">‚áÖ</span>
                    </span>
                  </th>

                  <th scope="col" (dblclick)="onDoubleClickSort('product.SGST')" class="sortable-header">
                    SGST
                    <span class="sort-icon">
                      <span *ngIf="sortColumn === 'product.SGST'">{{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}</span>
                      <span *ngIf="sortColumn !== 'product.SGST'" class="neutral-sort">‚áÖ</span>
                    </span>
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of stock; index as i" 
                    class="mobile-card" 
                    [class.expanded]="expandedIndex === i"
                    (click)="toggleCard(i); $event.stopPropagation()">
                  <td class="expandable" data-label="#" scope="row">{{ i + 1 }}</td>
                  <td data-label="Product Name" class="product-name">{{ item.product.name }}</td>
                  <td class="expandable" data-label="Packing">{{ item.product.packing }}</td>
                  <td class="expandable" data-label="HSN">{{ item.product.hsn }}</td>
                  <td class="expandable" data-label="Batch No.">{{ item.batchNo }}</td>
                  <td data-label="Expiry Date">{{ item.expiryDate | date }}</td>
                  <td data-label="Quantity"><span class="quantity-badge">{{ item.quantity | number }}</span></td>
                  <td data-label="MRP" class="price">‚Çπ{{ item.product.mrp | number }}</td>
                  <td class="expandable" data-label="CGST">{{ item.product?.cgst | number }}%</td>
                  <td class="expandable" data-label="SGST">{{ item.product?.sgst | number }}%</td>
                </tr>
              </tbody>
              <tbody *ngIf="stock.length === 0 && !isLoading" class="empty-state">
                <tr>
                  <td colspan="10" class="empty-state-cell">
                    <div class="empty-state-content">
                      <div class="empty-icon">üîç</div>
                      <p>No products found matching your criteria.</p>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Modern Pagination -->
        <div class="modern-pagination d-none d-md-flex">
          <nav aria-label="Page navigation">
            <ul class="pagination-list">
              <!-- First Page -->
              <li class="page-item" [class.disabled]="currentPage === 0">
                <a class="page-link" (click)="goToPage(0)">
                  <span>¬´</span>
                </a>
              </li>
              
              <!-- Previous -->
              <li class="page-item" [class.disabled]="currentPage === 0">
                <a class="page-link" (click)="goToPage(currentPage - 1)">
                  <span>‚Äπ</span>
                </a>
              </li>

              <!-- Dynamic Page Numbers -->
              <li class="page-item" *ngFor="let p of getVisiblePages()" [class.active]="currentPage === p">
                <a class="page-link" (click)="goToPage(p)">{{ p + 1 }}</a>
              </li>

              <!-- Next -->
              <li class="page-item" [class.disabled]="isLastPage">
                <a class="page-link" (click)="goToPage(currentPage + 1)">
                  <span>‚Ä∫</span>
                </a>
              </li>
              
              <!-- Last Page -->
              <li class="page-item" [class.disabled]="isLastPage">
                <a class="page-link" (click)="goToPage(totalPages - 1)">
                  <span>¬ª</span>
                </a>
              </li>
            </ul>
          </nav>
        </div>

        <!-- Loading Spinner for Mobile -->
        <div *ngIf="isLoading && stock.length > 0" class="mobile-loader d-md-none">
          <div class="spinner"></div>
        </div>

      </div>
    </div>

  </ng-container>
</ng-container>